---
title: "Gene weights"
author: "DongyueXie"
date: "2021-03-22"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Introduction

We discuss methods of calculating gene weights, when we create pseudo-bulk data from single cell reference data. 

When creating pseudo-bulk data, we have choices to add/do not add the technical noise(typically Poisson noise). If we simply merge raw counts of cells from single cell reference data, then the pseudo-bulk data have no technical noise(it's equivalent to take the individual reference matrix and multiply it by some cell type proportions, then the pseudo-bulk data have no technical noise). We can add technical noise(Poisson/negative binomial) to the pseudo-bulk data. 

List of method:

1. Calculate weights from true individual matrices - this is the oracle one. The weights are inverse of the diagonal of sample covariance of $(X_i-U)\beta$.

2. Calculate weights from individual reference matrices - from a reference dataset.

3. Take the inverse of squared residual as weights

4. Take the inverse of (squared residual + diagonal of sample covariance calculated using reference dataset) as weights

5. Take the inverse of (squared residual  + $\beta^TV_g\beta$) as weights

6. Use all bulk data to calculate weights.

We start with the no technical noise case. We'll create pseudo bulk data using Xin data and use Seger data as reference; and we'll also do the reverse.

```{r}
library(MuSiC)
library(Biobase)
library(xbioc)
source('code/deconference_main.R')
source('code/utils.R')
seger <- readRDS("data/pancreas/segerstolpe_raw.rds")

#XinT2D.eset <- readRDS("data/MuSiC/XinT2Deset.rds")
#XinT2D.construct.full = bulk_construct(XinT2D.eset, clusters = 'cellType', samples = 'SubjectName')
#XinT2D.construct.full$prop.real = relative.ab(XinT2D.construct.full$num.real, by.col = FALSE)
xin_raw <- readRDS("data/pancreas/xin_raw.rds")
baron = readRDS("data/pancreas/baron.rds")
```

```{r}
#'@param b either a vector or a matrix of dimension K*n_bulk
createBulk_no.tech.noise = function(X_array, b,gene_names){
  if(is.null(dim(b))){
    y = apply(X_array,3,function(z){z%*%b})
  }else{
    G = dim(X_array)[1]
    K = dim(X_array)[2]
    Ni = dim(X_array)[3]
    y = matrix(nrow=G,ncol=Ni)
    for(i in 1:Ni){
      y[,i] = X_array[,,i]%*%b[,i]
    }
  }
  rownames(y) = gene_names
  list(y=y,b=b)
}

createBulk_tech.noise = function(X_array, b, gene_names, ls_per_gene = 500,seed=12345){
  
  G = dim(X_array)[1]
  K = dim(X_array)[2]
  Ni = dim(X_array)[3]
    
  if(is.null(dim(b))){
    y = apply(X_array,3,function(z){z%*%b})
  }else{
    y = matrix(nrow=G,ncol=Ni)
    for(i in 1:Ni){
      y[,i] = X_array[,,i]%*%b[,i]
    }
  }
  y = y/colSums(y)*ls_per_gene*G
  set.seed(seed)
  y = matrix(rpois(prod(dim(y)),y),nrow=nrow(y),ncol=ncol(y))
  rownames(y) = gene_names
  list(y=y,b=b*ls_per_gene)
}

#'@param W variance, either a length G vector or a G*n_bulk matrix
#'@param b beta for evaluating weights
#'@param X reference matrix
#'@param Y bulk data
#'@param Vg variance
#'@param w.mode "equal", "res", "res+ref_var", "ref_var", "res+bvb"

wols = function(X,Y,
                Vg=NULL,
                b=NULL,
                w.mode = "res",
                adj.v = FALSE,
                nu = 1e-4,
                marker = NULL,
                scale.y = FALSE,
                X_array = NULL
               ){
  if(!is.null(marker)){
    X = X[marker,]
    Y = Y[marker,]
    Vg = Vg[marker,]
    if(!is.null(X_array)){
      X_array = X_array[marker,,]
    }
  }
  
  n = nrow(X)
  K = ncol(X)
  ni = ncol(Y)
  
  if(scale.y){
    Y = apply(Y,2,function(z){z/(sum(z)/n)})
  }

  
  
  
  if(is.null(b)){
    # then use b as
    b = c(rowMeans(solve(t(X)%*%X)%*%t(X)%*%Y))
  }
  
  Sigma_sample = c()
  for(i in 1:dim(X_array)[3]){
    Sigma_sample = cbind(Sigma_sample,(X_array[,,i] - X)%*%b)
  }
  w = diag.cov(t(Sigma_sample))
  W = w%*%t(rep(1,ni))
  
  if(is.null(dim(b))){
      b = b%*%t(rep(1,ni))
   }
    
  r = Y - X%*%b
  
  beta_hat = matrix(nrow=ni,ncol=K)
  for(j in 1:ni){
    
    if(w.mode=="equal"){
      wj = rep(1,n)
    }
    
    if(w.mode=="res"){
      wj = 1/(nu + r[,j]^2)
    }
    if(w.mode=="res+ref_var"){
      wj = 1/(nu + r[,j]^2+W[,j])
    }
    if(w.mode=="ref_var"){
      wj = 1/(nu +W[,j])
    }
    if(w.mode=="res+bvb"){
      noise_var = apply(Vg,1,function(v){
        if(length(v)==K^2){
          v = matrix(v,ncol = K)
        }else if(length(v)==K){
          V = diag(v)
        }
        t(b[,j])%*%v%*%b[,j]
      })
      wj = 1/(nu + r[,j]^2 + c(noise_var))
    }
    if(w.mode=="bvb"){
      noise_var = apply(Vg,1,function(v){
        if(length(v)==K^2){
          v = matrix(v,ncol = K)
        }else if(length(v)==K){
          V = diag(v)
        }
        t(b[,j])%*%v%*%b[,j]
      })
      wj = 1/(nu + c(noise_var))
    }
   
    wj = wj/sum(wj)
    
    #w.temp = 1/(W[j,]+nu)
    #w.temp = w.temp/sum(w.temp)
    #print(cor(wj,w.temp))
    
    Xw = X*sqrt(wj)
    yw = Y[,j]*sqrt(wj)
    
    A = t(Xw)%*%Xw
    if(adj.v){
      Vw = Vg*wj
      d_Vg = ncol(Vg)
      if(d_Vg==K^2){
        V = matrix(c(colSums(Vw)),ncol = K)
      }else if(d_Vg==K){
        V = diag(c(colSums(Vw)))
      }else{
        stop('check dimension of Vg')
      }
    }else{
      V = 0
    }
    
    bhat = solve(A-V)%*%t(Xw)%*%yw
    bhat = pmax(bhat,0)
    bhat = bhat/sum(bhat)
    beta_hat[j,] = bhat
  }
  beta_hat
}
```

```{r}

#'@param design.mat output from scRef_multi_proc, in which X is the reference matrix.
#'@param datax output from set_data_decon, in which y is the bulk data matrix.
#'@param b betas, K by n_bulk.


diag.cov = function(X){
  #center X
  X = scale(X,center=TRUE,scale=F)
  colSums(X^2)/(nrow(X)-1)
}

simu_func = function(design.mat,datax,b,b.res,marker.gene=NULL,scale.y=FALSE){
  
  n_bulk = ncol(datax$y)
  G = nrow(design.mat$X)
  
  if(!is.null(marker.gene)){
    marker = which(datax$genes%in%marker.gene)
  }else{
    marker = NULL
  }
  
  
  cat('---no weight---',"\n")


  b.est0 = wols(design.mat$X,datax$y,w.mode = 'equal',b=b.res,marker=marker,scale.y=scale.y,X_array = design.mat$X_array)
  print(paste("rmse",round(rmse(rep(1,n_bulk)%*%t(b/sum(b)),(b.est0)),3)))
  print(round(b.est0,2))

  b.est = wols(design.mat$X,datax$y,Vg = design.mat$Vg,b=b.res,w.mode='ref_var',adj.v = TRUE,marker=marker,scale.y=scale.y,X_array = design.mat$X_array)
  #print("No weight, ols adjusted for measurement error")
  print(paste("rmse",round(rmse(rep(1,n_bulk)%*%t(b/sum(b)),(b.est)),3)))
  print(round(b.est,2))
  
  cat('---weight from reference data---',"\n")
  
  if(is.null(b.res)){
    b.ols = c(rowMeans(solve(t(design.mat$X)%*%design.mat$X)%*%t(design.mat$X)%*%datax$y))
  }else{
    b.ols = b.res
  }
  

  b.est.ref0 = wols(design.mat$X,datax$y,w.mode = 'ref_var',b=b.res,marker=marker,scale.y=scale.y,X_array = design.mat$X_array)
  print(paste("rmse",round(rmse(rep(1,n_bulk)%*%t(b/sum(b)),(b.est.ref0)),3)))
  print(round(b.est.ref0,2))

  b.est.ref = wols(design.mat$X,datax$y,Vg = design.mat$Vg,b=b.res,w.mode='ref_var',adj.v = TRUE,marker=marker,scale.y=scale.y,X_array = design.mat$X_array)
  print(paste("rmse",round(rmse(rep(1,n_bulk)%*%t(b/sum(b)),(b.est.ref)),3)))
  print(round(b.est.ref,2))
  
  
  cat('---weight from residual---',"\n")
  
  b.est.ref0 = wols(design.mat$X,datax$y,b=b.res,w.mode='res',marker=marker,scale.y=scale.y,X_array = design.mat$X_array)
  print(paste("rmse",round(rmse(rep(1,n_bulk)%*%t(b/sum(b)),(b.est.ref0)),3)))
  print(round(b.est.ref0,2))

  b.est.ref = wols(design.mat$X,datax$y,Vg = design.mat$Vg,b=b.res,w.mode='res',adj.v = TRUE,marker=marker,scale.y=scale.y,X_array = design.mat$X_array)
  print(paste("rmse",round(rmse(rep(1,n_bulk)%*%t(b/sum(b)),(b.est.ref)),3)))
  print(round(b.est.ref,2))
  
  cat('---weight from residual and reference---',"\n")
  
  b.est.ref0 = wols(design.mat$X,datax$y,b=b.res,w.mode = 'res+ref_var',marker=marker,scale.y=scale.y,X_array = design.mat$X_array)
  print(paste("rmse",round(rmse(rep(1,n_bulk)%*%t(b/sum(b)),(b.est.ref0)),3)))
  print(round(b.est.ref0,2))

  b.est.ref = wols(design.mat$X,datax$y,Vg = design.mat$Vg,b=b.res,w.mode = 'res+ref_var',adj.v = TRUE,marker=marker,scale.y=scale.y,X_array = design.mat$X_array)
  print(paste("rmse",round(rmse(rep(1,n_bulk)%*%t(b/sum(b)),(b.est.ref)),3)))
  print(round(b.est.ref,2))
  
  cat('---weight from residual and reference bvb---',"\n")
  
  b.est.ref0 = wols(design.mat$X,datax$y,b=b.res,w.mode = 'res+bvb',Vg = design.mat$Vg,marker=marker,scale.y=scale.y,X_array = design.mat$X_array)
  print(paste("rmse",round(rmse(rep(1,n_bulk)%*%t(b/sum(b)),(b.est.ref0)),3)))
  print(round(b.est.ref0,2))

  b.est.ref = wols(design.mat$X,datax$y,Vg = design.mat$Vg,b=b.res,w.mode = 'res+bvb',adj.v = TRUE,marker=marker,scale.y=scale.y,X_array = design.mat$X_array)
  print(paste("rmse",round(rmse(rep(1,n_bulk)%*%t(b/sum(b)),(b.est.ref)),3)))
  print(round(b.est.ref,2))
  
}
```

## create bulk data(no technical noise) using Xin.

 $y = X\beta = U\beta + (X-U)\beta = U\beta + r$. 
 
 $y_g = u_g^T\beta+r_g$. 
 
 $w_g = 1/r_g^2$. 
 
 $y_g/r_g = x_g^T\beta/r_g+1$. So the fit is very good.

```{r}
cell_types = c('alpha', 'beta', 'delta', 'gamma')
K = length(cell_types)
rm.indi = c("Non T2D 4","Non T2D 7","Non T2D 10","Non T2D 12")
#rm.indi = levels(XinT2D.eset$SubjectName)[rm.indi]
rm.indi.idx = which(xin_raw$individual%in%rm.indi)

datax.xin = set_data_decon(Y = xin_raw[,-rm.indi.idx],cell_types = cell_types, gene_thresh = 0,max_count_quantile = 1,w=1)

design.mat.xin = scRef_multi_proc(datax.xin$Y,datax.xin$cell_type_idx,datax.xin$indi_idx,
                                  estimator="separate",est_sigma2 = FALSE,
                                    meta_var='plug_in',meta_mode='smooth',
                                    verbose = F)

# create bulk data
b = c(0.1,0.1,0.3,0.5)
bulk.xin = createBulk_no.tech.noise(design.mat.xin$X_array,b,gene_names = rownames(xin_raw))
```

### Using Seger as reference data

```{r}
datax.seger = set_data_decon(y = bulk.xin$y, Y = seger,
                       cell_types = cell_types, gene_thresh = 0,max_count_quantile = 1,w=1)

design.mat.seger = scRef_multi_proc(datax.seger$Y,datax.seger$cell_type_idx,datax.seger$indi_idx,estimator="separate",est_sigma2 = FALSE,
                                    meta_var='plug_in',meta_mode='smooth',
                                    verbose = F)
simu_func(design.mat.seger,datax.seger,b,b)

simu_func(design.mat.seger,datax.seger,b,NULL)

```

### Using Baron as reference data.

```{r}
datax.baron = set_data_decon(y = bulk.xin$y, Y = baron,
                       cell_types = cell_types, gene_thresh = 0,max_count_quantile = 1,w=1)

design.mat.baron = scRef_multi_proc(datax.baron$Y,datax.baron$cell_type_idx,datax.baron$indi_idx,estimator="separate",est_sigma2 = FALSE,
                                    meta_var='plug_in',meta_mode='smooth',
                                    verbose = F)

simu_func(design.mat.baron,datax.baron,b,b)
simu_func(design.mat.baron,datax.baron,b,NULL)

```


## create bulk data(no technical noise) using Seger

```{r}
bulk.seger = createBulk_no.tech.noise(design.mat.seger$X_array,b,datax.seger$genes)
```

### Xin as reference

```{r}

datax.xin = set_data_decon(y = bulk.seger$y, Y = xin_raw[,-rm.indi.idx],cell_types = cell_types, gene_thresh = 0,max_count_quantile = 1,w=1)
design.mat.xin = scRef_multi_proc(datax.xin$Y,datax.xin$cell_type_idx,datax.xin$indi_idx,
                                  estimator="separate",est_sigma2 = FALSE,
                                    meta_var='plug_in',meta_mode='smooth',
                                    verbose = F)
simu_func(design.mat.xin,datax.xin,b,b)
simu_func(design.mat.xin,datax.xin,b,NULL)

```


### Baron as reference

```{r}
datax.baron = set_data_decon(y = bulk.seger$y, Y = baron,
                       cell_types = cell_types, gene_thresh = 0,max_count_quantile = 1,w=1)

design.mat.baron = scRef_multi_proc(datax.baron$Y,datax.baron$cell_type_idx,datax.baron$indi_idx,estimator="separate",est_sigma2 = FALSE,
                                    meta_var='plug_in',meta_mode='smooth',
                                    verbose = F)

simu_func(design.mat.baron,datax.baron,b,b)
simu_func(design.mat.baron,datax.baron,b,NULL)

```



## create bulk data(with technical noise) using Xin.

```{r}
datax.xin = set_data_decon(Y = xin_raw[,-rm.indi.idx],cell_types = cell_types, gene_thresh = 0,max_count_quantile = 1,w=1)

design.mat.xin = scRef_multi_proc(datax.xin$Y,datax.xin$cell_type_idx,datax.xin$indi_idx,
                                  estimator="separate",est_sigma2 = FALSE,
                                    meta_var='plug_in',meta_mode='smooth',
                                    verbose = F)

# create bulk data
b = c(0.1,0.1,0.3,0.5)
bulk.xin = createBulk_tech.noise(design.mat.xin$X_array,b,gene_names = rownames(xin_raw))
```

### Using Seger as reference data

```{r}
datax.seger = set_data_decon(y = bulk.xin$y, Y = seger,
                       cell_types = cell_types, gene_thresh = 0,max_count_quantile = 1,w=1)

design.mat.seger = scRef_multi_proc(datax.seger$Y,datax.seger$cell_type_idx,datax.seger$indi_idx,estimator="separate",est_sigma2 = FALSE,
                                    meta_var='plug_in',meta_mode='smooth',
                                    verbose = F)

# true b for calculating weights
simu_func(design.mat.seger,datax.seger,bulk.xin$b,bulk.xin$b)


simu_func(design.mat.seger,datax.seger,bulk.xin$b,b.res=NULL)

simu_func(design.mat.seger,datax.seger,bulk.xin$b,b.res=NULL,scale.y = TRUE)

```


**gene weights comparison with cibersort x**

```{r}
seger_sig_cibersort_output = read.delim("data/pancreas/seger_sig_cibersort_output.txt", quote="")
sig_genes = seger_sig_cibersort_output[,1]
length(sig_genes)


Sigma_sample = c()
for(i in 1:dim(design.mat.seger$X_array)[3]){
  Sigma_sample = cbind(Sigma_sample,(design.mat.seger$X_array[,,i] - design.mat.seger$X)%*%bulk.xin$b)
}
w = diag.cov(t(Sigma_sample))

r = datax.seger$y - design.mat.seger$X%*%(bulk.xin$b%*%t(rep(1,14)))
genes_all = rownames(r)
w_cibersort = rep(0,length(genes_all))
names(w_cibersort) = genes_all
w_cibersort[names(w_cibersort)%in%sig_genes] = 1

nu = 1e-4

cor(1/(nu+w),w_cibersort)

plot(w_cibersort,1/(1e-4+w))

w2 = 1/(nu+w+r[,1]^2)
cor(w2,w_cibersort)

w3 = 1/(nu+w+r[,3]^2)
cor(w3,w_cibersort)

#cibersort result

seger_cibersort_Results = read.delim("data/pancreas/seger_cibersort_Results.txt", quote="")
cibersort_est = seger_cibersort_Results[,2:5]
cibersort_est = cibersort_est[,c(2,4,1,3)]
round(cibersort_est,2)
rmse(as.matrix(cibersort_est),(rep(1,14))%*%t(b))


```

use cibersort marker gene

```{r}
simu_func(design.mat.seger,datax.seger,bulk.xin$b,b.res=bulk.xin$b,marker.gene = sig_genes)
simu_func(design.mat.seger,datax.seger,bulk.xin$b,b.res=NULL,marker.gene = sig_genes)
```

### Using Baron as reference data.

```{r}
datax.baron = set_data_decon(y = bulk.xin$y, Y = baron,
                       cell_types = cell_types, gene_thresh = 0,max_count_quantile = 1,w=1)

design.mat.baron = scRef_multi_proc(datax.baron$Y,datax.baron$cell_type_idx,datax.baron$indi_idx,estimator="separate",est_sigma2 = FALSE,
                                    meta_var='plug_in',meta_mode='smooth',
                                    verbose = F)

simu_func(design.mat.baron,datax.baron,bulk.xin$b,bulk.xin$b)



simu_func(design.mat.baron,datax.baron,bulk.xin$b,NULL)

simu_func(design.mat.baron,datax.baron,bulk.xin$b,NULL,scale.y = TRUE)



```


## create bulk data(with technical noise) using Seger

```{r}
bulk.seger = createBulk_tech.noise(design.mat.seger$X_array,b,datax.seger$genes)
```

### Xin as reference

```{r}

datax.xin = set_data_decon(y = bulk.seger$y, Y = xin_raw[,-rm.indi.idx],cell_types = cell_types, gene_thresh = 0,max_count_quantile = 1,w=1)
design.mat.xin = scRef_multi_proc(datax.xin$Y,datax.xin$cell_type_idx,datax.xin$indi_idx,
                                  estimator="separate",est_sigma2 = FALSE,
                                    meta_var='plug_in',meta_mode='smooth',
                                    verbose = F)
simu_func(design.mat.xin,datax.xin,bulk.seger$b,bulk.seger$b)
simu_func(design.mat.xin,datax.xin,bulk.seger$b,NULL)
simu_func(design.mat.xin,datax.xin,bulk.seger$b,NULL,scale.y = TRUE)

```


### Baron as reference

```{r}
datax.baron = set_data_decon(y = bulk.seger$y, Y = baron,
                       cell_types = cell_types, gene_thresh = 0,max_count_quantile = 1,w=1)

design.mat.baron = scRef_multi_proc(datax.baron$Y,datax.baron$cell_type_idx,datax.baron$indi_idx,estimator="separate",est_sigma2 = FALSE,
                                    meta_var='plug_in',meta_mode='smooth',
                                    verbose = F)

simu_func(design.mat.baron,datax.baron,bulk.seger$b,bulk.seger$b)
simu_func(design.mat.baron,datax.baron,bulk.seger$b,NULL)
simu_func(design.mat.baron,datax.baron,bulk.seger$b,NULL,scale.y = TRUE)

```




