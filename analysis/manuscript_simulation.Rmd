---
title: "manuscript simulation"
author: "DongyueXie"
date: "2021-08-15"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---


```{r}
b1 = c(0.1,0.1,0.3,0.5)
b2 = c(0.1,0.2,0.5,0.2)
nb = 10
b = cbind(b1%*%t(rep(1,nb/2)),b2%*%t(rep(1,nb/2)))

get_rmse = function(p_hat,b){
  K = dim(p_hat)[1]
  nb = dim(p_hat)[2]
  nreps = dim(p_hat)[3]
  rmses = c()
  for(i in 1:nb){
    err = c()
    for(j in 1:nreps){
      err[j] = sum((p_hat[,i,j]-b[,i])^2)
    }
    rmses[i] = sqrt(mean(err))
  }
  names(rmses) = paste('bulk',1:nb)
  round(rmses,3)

}

get_coverage_p = function(p_hat,p_hat_se,b){

  K = dim(p_hat)[1]
  nb = dim(p_hat)[2]
  z = array(dim = dim(p_hat))
  for(i in 1:dim(z)[3]){
    z[,,i] = (p_hat[,,i]-b)/p_hat_se[,,i]
  }
  crg = apply(z,c(1,2),function(z){round(mean(abs(z)<1.96,na.rm=T),3)})
  rownames(crg) = paste('cell',1:K)
  colnames(crg) = paste('bulk',1:nb)
  crg
}

get_power_diff = function(diff_hat,diff_hat_se){
  colMeans(abs(diff_hat/diff_hat_se)>1.96,na.rm=TRUE)
}


```


In this simulation, the population gene expression matrix $U$ and across individual variances $\Sigma$ are inferred from Xin data, 14 individuals(after removing 4 individuals that missing certain cell types), by running meta-analysis per gene and cell type. We kept genes that have expressions in at least $5\%$ cells and filtered out genes that has expressions exceeding the $95\%$ quantile in each cell type and individual. After filtering, total 9496 genes are left. 

In each of 100 repetition, 10 reference matrices are generated using log-normal distribution and postive correlations are introduced as a banded matrix; 10 bulk data are generated and divded into 2 groups. The first group has cell type proportion $(0.1,0.1,0.3,0.5)$ and the second group has proportion $(0.1,0.2,0.5,0.3)$. 

We compared four methods: ordinary least square, the proposed measurement error adjustment method, the proposed method with correlation adjustment, the proposed method with both correlation adjustment and weights.

The first comparison is the root mean squared error, calculated for each bulk data as $\sqrt{\frac{1}{100}\sum_{i=1}^{100}||\hat p_i - p||^2}$. We will also look at the coverage as well as the two group testing.

## correlated gene 500

In the first case, each gene is correlated with 500 other genes via a banded correlation matrix. 100 bulk data are generated for inferring the correlated gene pairs and a fdr level 0.5 was used.

```{r}
simu_out = readRDS('output/manuscript/simulation_10bulk_500genecor_fdr05.rds')
```

```{r, results = 'asis'}
rmse_out = rbind(get_rmse(simu_out$p_hat_ols,b),
get_rmse(simu_out$p_hat,b),
get_rmse(simu_out$p_hat_weight,b))
rownames(rmse_out) = c('ols','m.err.adj','m.err.adj.weighted')
knitr::kable(rmse_out,caption='rooted mean sqaured errors')
```

```{r, results = 'asis'}
knitr::kable(get_coverage_p(simu_out$p_hat_ols,simu_out$p_hat_ols_se,b),caption='ols')
knitr::kable(get_coverage_p(simu_out$p_hat,simu_out$p_hat_se,b),caption='m.err.adj')
knitr::kable(get_coverage_p(simu_out$p_hat,simu_out$p_hat_se_cor,b),caption='m.err.cor.adj')
knitr::kable(get_coverage_p(simu_out$p_hat_weight,simu_out$p_hat_weight_se_cor,b),caption='m.err.cor.adj.weighted')
```

```{r, results = 'asis'}
test = rbind(get_power_diff(simu_out$diff_hat_ols,simu_out$diff_hat_ols_se),
get_power_diff(simu_out$diff_hat,simu_out$diff_hat_se),
get_power_diff(simu_out$diff_hat,simu_out$diff_hat_se_cor),
get_power_diff(simu_out$diff_hat_weight,simu_out$diff_hat_weight_se_cor))
rownames(test) = c('ols','m.err.adj','m.err.cor.adj','m.err.cor.adj.weighted')
colnames(test) = c('type 1 error','power','power','power')
knitr::kable(test)
```


## correlated gene 300

In the second case, each gene is correlated with 300 other genes via a banded correlation matrix. 100 bulk data are generated for inferring the correlated gene pairs and a fdr level 0.5 was used.

```{r}
simu_out = readRDS('output/manuscript/simulation_10bulk_300genecor_fdr05.rds')
```

```{r, results = 'asis'}
rmse_out = rbind(get_rmse(simu_out$p_hat_ols,b),
get_rmse(simu_out$p_hat,b),
get_rmse(simu_out$p_hat_weight,b))
rownames(rmse_out) = c('ols','m.err.adj','m.err.adj.weighted')
knitr::kable(rmse_out,caption='rooted mean sqaured errors')
```

```{r, results = 'asis'}
knitr::kable(get_coverage_p(simu_out$p_hat_ols,simu_out$p_hat_ols_se,b),caption='ols')
knitr::kable(get_coverage_p(simu_out$p_hat,simu_out$p_hat_se,b),caption='m.err.adj')
knitr::kable(get_coverage_p(simu_out$p_hat,simu_out$p_hat_se_cor,b),caption='m.err.cor.adj')
knitr::kable(get_coverage_p(simu_out$p_hat_weight,simu_out$p_hat_weight_se_cor,b),caption='m.err.cor.adj.weighted')
```

```{r, results = 'asis'}
test = rbind(get_power_diff(simu_out$diff_hat_ols,simu_out$diff_hat_ols_se),
get_power_diff(simu_out$diff_hat,simu_out$diff_hat_se),
get_power_diff(simu_out$diff_hat,simu_out$diff_hat_se_cor),
get_power_diff(simu_out$diff_hat_weight,simu_out$diff_hat_weight_se_cor))
rownames(test) = c('ols','m.err.adj','m.err.cor.adj','m.err.cor.adj.weighted')
colnames(test) = c('type 1 error','power','power','power')
knitr::kable(test)
```

## correlated gene 0

No correlation is presented. 100 bulk data are generated for inferring the correlated gene pairs and a fdr level 0.5 was used.

```{r}
simu_out = readRDS('output/manuscript/simulation_10bulk_0genecor_fdr05.rds')
```

```{r, results = 'asis'}
rmse_out = rbind(get_rmse(simu_out$p_hat_ols,b),
get_rmse(simu_out$p_hat,b),
get_rmse(simu_out$p_hat_weight,b))
rownames(rmse_out) = c('ols','m.err.adj','m.err.adj.weighted')
knitr::kable(rmse_out,caption='rooted mean sqaured errors')
```

```{r, results = 'asis'}
knitr::kable(get_coverage_p(simu_out$p_hat_ols,simu_out$p_hat_ols_se,b),caption='ols')
knitr::kable(get_coverage_p(simu_out$p_hat,simu_out$p_hat_se,b),caption='m.err.adj')
knitr::kable(get_coverage_p(simu_out$p_hat,simu_out$p_hat_se_cor,b),caption='m.err.cor.adj')
knitr::kable(get_coverage_p(simu_out$p_hat_weight,simu_out$p_hat_weight_se_cor,b),caption='m.err.cor.adj.weighted')
```

```{r, results = 'asis'}
test = rbind(get_power_diff(simu_out$diff_hat_ols,simu_out$diff_hat_ols_se),
get_power_diff(simu_out$diff_hat,simu_out$diff_hat_se),
get_power_diff(simu_out$diff_hat,simu_out$diff_hat_se_cor),
get_power_diff(simu_out$diff_hat_weight,simu_out$diff_hat_weight_se_cor))
rownames(test) = c('ols','m.err.adj','m.err.cor.adj','m.err.cor.adj.weighted')
colnames(test) = c('type 1 error','power','power','power')
knitr::kable(test)
```


**why the coverage of cell type 3 is so low when adding weights?**

The true sd of the third proportion of the first bulk data, and the mean of estimated ones,
```{r}
sd(simu_out$p_hat_weight[3,1,])
mean(simu_out$p_hat_weight_se_cor[3,1,],na.rm=T)
qqnorm(simu_out$p_hat_weight[3,1,])
qqline(simu_out$p_hat_weight[3,1,])
h = hist((simu_out$p_hat_weight[3,1,]-0.3)/simu_out$p_hat_weight_se_cor[3,1,],breaks = 20,main='histogram of z score',xlab='')
xfit<-seq(-3,3,length=40)
yfit<-dnorm(xfit,mean=0,sd=1)
yfit <- yfit*diff(h$mids[1:2])*length((simu_out$p_hat_weight[3,1,]-0.3)/simu_out$p_hat_weight_se_cor[3,1,])
lines(xfit, yfit, col="blue", lwd=2)
```

**other**

- negative diagonal elements of asymptotic covariance matrix


