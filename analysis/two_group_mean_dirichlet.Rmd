---
title: "Testing two group means"
author: "DongyueXie"
date: "2021-10-05"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---




## Introduction

In this simulation, we set two groups with either equal or unequal means $p_1,p_2$, then generate proportions using a Dirichlet distribution with parameters $p*10$.

```{r}
get_rmse = function(p_hat,b){
  K = dim(p_hat)[1]
  nb = dim(p_hat)[2]
  nreps = dim(p_hat)[3]
  rmses = c()
  for(i in 1:nb){
    err = c()
    for(j in 1:nreps){
      err[j] = sum((p_hat[,i,j]-b[,i])^2)
    }
    rmses[i] = sqrt(mean(err))
  }
  names(rmses) = paste('bulk',1:nb)
  round(rmses,3)

}

get_coverage_p = function(p_hat,p_hat_se,b){

  K = dim(p_hat)[1]
  nb = dim(p_hat)[2]
  z = array(dim = dim(p_hat))
  for(i in 1:dim(z)[3]){
    z[,,i] = (p_hat[,,i]-b)/p_hat_se[,,i]
  }
  crg = apply(z,c(1,2),function(z){round(mean(abs(z)<1.96,na.rm=T),3)})
  rownames(crg) = paste('cell',1:K)
  colnames(crg) = paste('bulk',1:nb)
  crg
}

```

## NULL

### 50 bulk data

```{r}
simu_out = readRDS('output/manuscript/simulation/simulation_50bulk_500genecor_fdr05_null_dirichlet.rds')
```

```{r}
K = 4
nreps = 100
nb = 50
p1 = c(0.5,0.3,0.1,0.1)
p2 = c(0.5,0.3,0.1,0.1)
dif = p1-p2

dif
```

#### Coverage of group difference

```{r}
print('two sample t test, weighted meaurement error model')
cover.naive = matrix(nrow = nreps,ncol=K)
sd.naive = matrix(nrow = nreps,ncol=K)
for(i in 1:nreps){
  for(k in 1:K){
    temp = t.test(simu_out$p_hat_weight[k,1:(nb/2),i],simu_out$p_hat_weight[k,(nb/2+1):nb,i])
    sd.naive[i,k] = temp$stderr
    cover.naive[i,k] = (dif[k]>temp$conf.int[1])&(dif[k]<temp$conf.int[2])
  }
}
colMeans(cover.naive)
round(colMeans(sd.naive),3)

print('two sample t test, music')
cover.naive.music = matrix(nrow = nreps,ncol=K)
sd.naive.music = matrix(nrow = nreps,ncol=K)
for(i in 1:nreps){
  for(k in 1:K){
    temp = t.test(simu_out$p_hat_music[k,1:(nb/2),i],simu_out$p_hat_music[k,(nb/2+1):nb,i])
    sd.naive.music[i,k] = temp$stderr
    cover.naive.music[i,k] = (dif[k]>temp$conf.int[1])&(dif[k]<temp$conf.int[2])
  }
}
colMeans(cover.naive.music)
round(colMeans(sd.naive.music),3)

print('asymptotic,hc3')
temp = abs(simu_out$diff_hat - rep(1,nreps)%*%t(dif))/simu_out$diff_hat_se_cor
cover.asy.hc3 = temp<1.96
round(colMeans(cover.asy.hc3,na.rm=TRUE),2)
round(colMeans(simu_out$diff_hat_se_cor),3)

print('asymptotic, weighted, hc3')
temp = abs(simu_out$diff_hat_weight - rep(1,nreps)%*%t(dif))/simu_out$diff_hat_weight_se_cor
cover.asy.hc3 = temp<1.96
round(colMeans(cover.asy.hc3,na.rm=TRUE),2)
round(colMeans(simu_out$diff_hat_weight_se_cor),3)

print('asymptotic, weighted, cv')
temp = abs(simu_out$diff_hat_weight - rep(1,nreps)%*%t(dif))/simu_out$diff_hat_weight_se_cor_cv
cover.asy.cv = temp<1.96
round(colMeans(cover.asy.cv,na.rm=TRUE),2)
round(colMeans(simu_out$diff_hat_weight_se_cor_cv),3)

# print('add up the variance of asymptotic and two sample test')
# 
# cover.union = (cover.naive)|(cover.asy.hc3)
# round(colMeans(cover.union,na.rm = T),2)
# 
# cover.union = (cover.naive)|(cover.asy.cv)
# round(colMeans(cover.union,na.rm = T),2)
```

#### rmse, coverage of p

```{r}
mean(get_rmse(simu_out$p_hat_weight,simu_out$input$b))
mean(get_rmse(simu_out$p_hat_music,simu_out$input$b))
```

```{r}
mean(get_coverage_p(simu_out$p_hat_weight,simu_out$p_hat_weight_se_cor,simu_out$input$b))
mean(get_coverage_p(simu_out$p_hat_weight,simu_out$p_hat_weight_se_cor_cv,simu_out$input$b))
```

### 100 bulk data

```{r}
simu_out = readRDS('output/manuscript/simulation/simulation_100bulk_500genecor_fdr05_null_dirichlet.rds')
```

```{r}
K = 4
nreps = 100
nb = 100
b1 = c(0.5,0.3,0.1,0.1)
b2 = c(0.5,0.3,0.1,0.1)
dif = b1-b2

dif
```

#### Coverage of group difference

```{r}
print('two sample t test, weighted meaurement error model')
cover.naive = matrix(nrow = nreps,ncol=K)
sd.naive = matrix(nrow = nreps,ncol=K)
for(i in 1:nreps){
  for(k in 1:K){
    temp = t.test(simu_out$p_hat_weight[k,1:(nb/2),i],simu_out$p_hat_weight[k,(nb/2+1):nb,i])
    sd.naive[i,k] = temp$stderr
    cover.naive[i,k] = (dif[k]>temp$conf.int[1])&(dif[k]<temp$conf.int[2])
  }
}
colMeans(cover.naive)
round(colMeans(sd.naive),3)

print('two sample t test, music')
cover.naive.music = matrix(nrow = nreps,ncol=K)
sd.naive.music = matrix(nrow = nreps,ncol=K)
for(i in 1:nreps){
  for(k in 1:K){
    temp = t.test(simu_out$p_hat_music[k,1:(nb/2),i],simu_out$p_hat_music[k,(nb/2+1):nb,i])
    sd.naive.music[i,k] = temp$stderr
    cover.naive.music[i,k] = (dif[k]>temp$conf.int[1])&(dif[k]<temp$conf.int[2])
  }
}
colMeans(cover.naive.music)
round(colMeans(sd.naive.music),3)

print('asymptotic,hc3')
temp = abs(simu_out$diff_hat - rep(1,nreps)%*%t(dif))/simu_out$diff_hat_se_cor
cover.asy.hc3 = temp<1.96
round(colMeans(cover.asy.hc3,na.rm=TRUE),2)
round(colMeans(simu_out$diff_hat_se_cor),3)

print('asymptotic, weighted, hc3')
temp = abs(simu_out$diff_hat_weight - rep(1,nreps)%*%t(dif))/simu_out$diff_hat_weight_se_cor
cover.asy.hc3 = temp<1.96
round(colMeans(cover.asy.hc3,na.rm=TRUE),2)
round(colMeans(simu_out$diff_hat_weight_se_cor),3)

print('asymptotic, weighted, cv')
temp = abs(simu_out$diff_hat_weight - rep(1,nreps)%*%t(dif))/simu_out$diff_hat_weight_se_cor_cv
cover.asy.cv = temp<1.96
round(colMeans(cover.asy.cv,na.rm=TRUE),2)
round(colMeans(simu_out$diff_hat_weight_se_cor_cv),3)

# print('add up the variance of asymptotic and two sample test')
# 
# cover.union = (cover.naive)|(cover.asy.hc3)
# round(colMeans(cover.union,na.rm = T),2)
# 
# cover.union = (cover.naive)|(cover.asy.cv)
# round(colMeans(cover.union,na.rm = T),2)
```

#### rmse, coverage of p

```{r}
mean(get_rmse(simu_out$p_hat_weight,simu_out$input$b))
mean(get_rmse(simu_out$p_hat_music,simu_out$input$b))
```

```{r}
mean(get_coverage_p(simu_out$p_hat_weight,simu_out$p_hat_weight_se_cor,simu_out$input$b))
mean(get_coverage_p(simu_out$p_hat_weight,simu_out$p_hat_weight_se_cor_cv,simu_out$input$b))
```


## All diff

### 50 bulk data

```{r}
simu_out = readRDS('output/manuscript/simulation/simulation_50bulk_500genecor_fdr05_all_diff_dirichlet.rds')
```

```{r}
K = 4
nreps = 100
nb = 50
p1 = c(0.5,0.3,0.1,0.1)
p2 = c(0.1,0.1,0.3,0.5)
dif = p1-p2

dif
```

#### Coverage of group difference

```{r}
print('two sample t test, weighted meaurement error model')
cover.naive = matrix(nrow = nreps,ncol=K)
sd.naive = matrix(nrow = nreps,ncol=K)
for(i in 1:nreps){
  for(k in 1:K){
    temp = t.test(simu_out$p_hat_weight[k,1:(nb/2),i],simu_out$p_hat_weight[k,(nb/2+1):nb,i])
    sd.naive[i,k] = temp$stderr
    cover.naive[i,k] = (dif[k]>temp$conf.int[1])&(dif[k]<temp$conf.int[2])
  }
}
colMeans(cover.naive)
round(colMeans(sd.naive),3)

print('two sample t test, music')
cover.naive.music = matrix(nrow = nreps,ncol=K)
sd.naive.music = matrix(nrow = nreps,ncol=K)
for(i in 1:nreps){
  for(k in 1:K){
    temp = t.test(simu_out$p_hat_music[k,1:(nb/2),i],simu_out$p_hat_music[k,(nb/2+1):nb,i])
    sd.naive.music[i,k] = temp$stderr
    cover.naive.music[i,k] = (dif[k]>temp$conf.int[1])&(dif[k]<temp$conf.int[2])
  }
}
colMeans(cover.naive.music)
round(colMeans(sd.naive.music),3)

print('asymptotic,hc3')
temp = abs(simu_out$diff_hat - rep(1,nreps)%*%t(dif))/simu_out$diff_hat_se_cor
cover.asy.hc3 = temp<1.96
round(colMeans(cover.asy.hc3,na.rm=TRUE),2)
round(colMeans(simu_out$diff_hat_se_cor),3)

print('asymptotic, weighted, hc3')
temp = abs(simu_out$diff_hat_weight - rep(1,nreps)%*%t(dif))/simu_out$diff_hat_weight_se_cor
cover.asy.hc3 = temp<1.96
round(colMeans(cover.asy.hc3,na.rm=TRUE),2)
round(colMeans(simu_out$diff_hat_weight_se_cor),3)

print('asymptotic, weighted, cv')
temp = abs(simu_out$diff_hat_weight - rep(1,nreps)%*%t(dif))/simu_out$diff_hat_weight_se_cor_cv
cover.asy.cv = temp<1.96
round(colMeans(cover.asy.cv,na.rm=TRUE),2)
round(colMeans(simu_out$diff_hat_weight_se_cor_cv),3)

# print('add up the variance of asymptotic and two sample test')
# 
# cover.union = (cover.naive)|(cover.asy.hc3)
# round(colMeans(cover.union,na.rm = T),2)
# 
# cover.union = (cover.naive)|(cover.asy.cv)
# round(colMeans(cover.union,na.rm = T),2)
```

#### rmse, coverage of p

```{r}
mean(get_rmse(simu_out$p_hat_weight,simu_out$input$b))
mean(get_rmse(simu_out$p_hat_music,simu_out$input$b))
```

```{r}
mean(get_coverage_p(simu_out$p_hat_weight,simu_out$p_hat_weight_se_cor,simu_out$input$b))
mean(get_coverage_p(simu_out$p_hat_weight,simu_out$p_hat_weight_se_cor_cv,simu_out$input$b))

```

### 100 bulk data

```{r}
simu_out = readRDS('output/manuscript/simulation/simulation_100bulk_500genecor_fdr05_all_diff_dirichlet.rds')
```

```{r}
K = 4
nreps = 100
nb = 100
p1 = c(0.5,0.3,0.1,0.1)
p2 = c(0.1,0.1,0.3,0.5)
dif = p1-p2

dif
```

#### Coverage of group difference

```{r}
print('two sample t test, weighted meaurement error model')
cover.naive = matrix(nrow = nreps,ncol=K)
sd.naive = matrix(nrow = nreps,ncol=K)
for(i in 1:nreps){
  for(k in 1:K){
    temp = t.test(simu_out$p_hat_weight[k,1:(nb/2),i],simu_out$p_hat_weight[k,(nb/2+1):nb,i])
    sd.naive[i,k] = temp$stderr
    cover.naive[i,k] = (dif[k]>temp$conf.int[1])&(dif[k]<temp$conf.int[2])
  }
}
colMeans(cover.naive)
round(colMeans(sd.naive),3)

print('two sample t test, music')
cover.naive.music = matrix(nrow = nreps,ncol=K)
sd.naive.music = matrix(nrow = nreps,ncol=K)
for(i in 1:nreps){
  for(k in 1:K){
    temp = t.test(simu_out$p_hat_music[k,1:(nb/2),i],simu_out$p_hat_music[k,(nb/2+1):nb,i])
    sd.naive.music[i,k] = temp$stderr
    cover.naive.music[i,k] = (dif[k]>temp$conf.int[1])&(dif[k]<temp$conf.int[2])
  }
}
colMeans(cover.naive.music)
round(colMeans(sd.naive.music),3)

print('asymptotic,hc3')
temp = abs(simu_out$diff_hat - rep(1,nreps)%*%t(dif))/simu_out$diff_hat_se_cor
cover.asy.hc3 = temp<1.96
round(colMeans(cover.asy.hc3,na.rm=TRUE),2)
round(colMeans(simu_out$diff_hat_se_cor),3)

print('asymptotic, weighted, hc3')
temp = abs(simu_out$diff_hat_weight - rep(1,nreps)%*%t(dif))/simu_out$diff_hat_weight_se_cor
cover.asy.hc3 = temp<1.96
round(colMeans(cover.asy.hc3,na.rm=TRUE),2)
round(colMeans(simu_out$diff_hat_weight_se_cor),3)

print('asymptotic, weighted, cv')
temp = abs(simu_out$diff_hat_weight - rep(1,nreps)%*%t(dif))/simu_out$diff_hat_weight_se_cor_cv
cover.asy.cv = temp<1.96
round(colMeans(cover.asy.cv,na.rm=TRUE),2)
round(colMeans(simu_out$diff_hat_weight_se_cor_cv),3)

# print('add up the variance of asymptotic and two sample test')
# 
# cover.union = (cover.naive)|(cover.asy.hc3)
# round(colMeans(cover.union,na.rm = T),2)
# 
# cover.union = (cover.naive)|(cover.asy.cv)
# round(colMeans(cover.union,na.rm = T),2)
```

#### rmse, coverage of p

```{r}
mean(get_rmse(simu_out$p_hat_weight,simu_out$input$b))
mean(get_rmse(simu_out$p_hat_music,simu_out$input$b))
```

```{r}
mean(get_coverage_p(simu_out$p_hat_weight,simu_out$p_hat_weight_se_cor,simu_out$input$b))
mean(get_coverage_p(simu_out$p_hat_weight,simu_out$p_hat_weight_se_cor_cv,simu_out$input$b))
```



## One same

### 50 bulk data

```{r}
simu_out = readRDS('output/manuscript/simulation/simulation_50bulk_500genecor_fdr05_one_diff_dirichlet.rds')
```

```{r}
K = 4
nreps = 100
nb = 50
p1 = c(0.1,0.1,0.3,0.5)
p2 = c(0.1,0.15,0.4,0.35)
dif = p1-p2

dif
```

#### Coverage of group difference

```{r}
print('two sample t test, weighted meaurement error model')
cover.naive = matrix(nrow = nreps,ncol=K)
sd.naive = matrix(nrow = nreps,ncol=K)
for(i in 1:nreps){
  for(k in 1:K){
    temp = t.test(simu_out$p_hat_weight[k,1:(nb/2),i],simu_out$p_hat_weight[k,(nb/2+1):nb,i])
    sd.naive[i,k] = temp$stderr
    cover.naive[i,k] = (dif[k]>temp$conf.int[1])&(dif[k]<temp$conf.int[2])
  }
}
colMeans(cover.naive)
round(colMeans(sd.naive),3)

print('two sample t test, music')
cover.naive.music = matrix(nrow = nreps,ncol=K)
sd.naive.music = matrix(nrow = nreps,ncol=K)
for(i in 1:nreps){
  for(k in 1:K){
    temp = t.test(simu_out$p_hat_music[k,1:(nb/2),i],simu_out$p_hat_music[k,(nb/2+1):nb,i])
    sd.naive.music[i,k] = temp$stderr
    cover.naive.music[i,k] = (dif[k]>temp$conf.int[1])&(dif[k]<temp$conf.int[2])
  }
}
colMeans(cover.naive.music)
round(colMeans(sd.naive.music),3)

print('asymptotic,hc3')
temp = abs(simu_out$diff_hat - rep(1,nreps)%*%t(dif))/simu_out$diff_hat_se_cor
cover.asy.hc3 = temp<1.96
round(colMeans(cover.asy.hc3,na.rm=TRUE),2)
round(colMeans(simu_out$diff_hat_se_cor),3)

print('asymptotic, weighted, hc3')
temp = abs(simu_out$diff_hat_weight - rep(1,nreps)%*%t(dif))/simu_out$diff_hat_weight_se_cor
cover.asy.hc3 = temp<1.96
round(colMeans(cover.asy.hc3,na.rm=TRUE),2)
round(colMeans(simu_out$diff_hat_weight_se_cor),3)

print('asymptotic, weighted, cv')
temp = abs(simu_out$diff_hat_weight - rep(1,nreps)%*%t(dif))/simu_out$diff_hat_weight_se_cor_cv
cover.asy.cv = temp<1.96
round(colMeans(cover.asy.cv,na.rm=TRUE),2)
round(colMeans(simu_out$diff_hat_weight_se_cor_cv),3)

# print('add up the variance of asymptotic and two sample test')
# 
# cover.union = (cover.naive)|(cover.asy.hc3)
# round(colMeans(cover.union,na.rm = T),2)
# 
# cover.union = (cover.naive)|(cover.asy.cv)
# round(colMeans(cover.union,na.rm = T),2)
```

#### rmse, coverage of p

```{r}
mean(get_rmse(simu_out$p_hat_weight,simu_out$input$b))
mean(get_rmse(simu_out$p_hat_music,simu_out$input$b))
```

```{r}
mean(get_coverage_p(simu_out$p_hat_weight,simu_out$p_hat_weight_se_cor,simu_out$input$b))
mean(get_coverage_p(simu_out$p_hat_weight,simu_out$p_hat_weight_se_cor_cv,simu_out$input$b))

```

### 100 bulk data

```{r}
simu_out = readRDS('output/manuscript/simulation/simulation_100bulk_500genecor_fdr05_one_diff_dirichlet.rds')
```

```{r}
K = 4
nreps = 100
nb = 100
```

#### Coverage of group difference

```{r}
print('two sample t test, weighted meaurement error model')
cover.naive = matrix(nrow = nreps,ncol=K)
sd.naive = matrix(nrow = nreps,ncol=K)
for(i in 1:nreps){
  for(k in 1:K){
    temp = t.test(simu_out$p_hat_weight[k,1:(nb/2),i],simu_out$p_hat_weight[k,(nb/2+1):nb,i])
    sd.naive[i,k] = temp$stderr
    cover.naive[i,k] = (dif[k]>temp$conf.int[1])&(dif[k]<temp$conf.int[2])
  }
}
colMeans(cover.naive)
round(colMeans(sd.naive),3)

print('two sample t test, music')
cover.naive.music = matrix(nrow = nreps,ncol=K)
sd.naive.music = matrix(nrow = nreps,ncol=K)
for(i in 1:nreps){
  for(k in 1:K){
    temp = t.test(simu_out$p_hat_music[k,1:(nb/2),i],simu_out$p_hat_music[k,(nb/2+1):nb,i])
    sd.naive.music[i,k] = temp$stderr
    cover.naive.music[i,k] = (dif[k]>temp$conf.int[1])&(dif[k]<temp$conf.int[2])
  }
}
colMeans(cover.naive.music)
round(colMeans(sd.naive.music),3)

print('asymptotic,hc3')
temp = abs(simu_out$diff_hat - rep(1,nreps)%*%t(dif))/simu_out$diff_hat_se_cor
cover.asy.hc3 = temp<1.96
round(colMeans(cover.asy.hc3,na.rm=TRUE),2)
round(colMeans(simu_out$diff_hat_se_cor),3)

print('asymptotic, weighted, hc3')
temp = abs(simu_out$diff_hat_weight - rep(1,nreps)%*%t(dif))/simu_out$diff_hat_weight_se_cor
cover.asy.hc3 = temp<1.96
round(colMeans(cover.asy.hc3,na.rm=TRUE),2)
round(colMeans(simu_out$diff_hat_weight_se_cor),3)

print('asymptotic, weighted, cv')
temp = abs(simu_out$diff_hat_weight - rep(1,nreps)%*%t(dif))/simu_out$diff_hat_weight_se_cor_cv
cover.asy.cv = temp<1.96
round(colMeans(cover.asy.cv,na.rm=TRUE),2)
round(colMeans(simu_out$diff_hat_weight_se_cor_cv),3)

# print('add up the variance of asymptotic and two sample test')
# 
# cover.union = (cover.naive)|(cover.asy.hc3)
# round(colMeans(cover.union,na.rm = T),2)
# 
# cover.union = (cover.naive)|(cover.asy.cv)
# round(colMeans(cover.union,na.rm = T),2)
```

#### rmse, coverage of p

```{r}
mean(get_rmse(simu_out$p_hat_weight,simu_out$input$b))
mean(get_rmse(simu_out$p_hat_music,simu_out$input$b))
```

```{r}
mean(get_coverage_p(simu_out$p_hat_weight,simu_out$p_hat_weight_se_cor,simu_out$input$b))
mean(get_coverage_p(simu_out$p_hat_weight,simu_out$p_hat_weight_se_cor_cv,simu_out$input$b))
```





