---
title: "Testing two group means"
author: "DongyueXie"
date: "2021-10-05"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---




# Introduction

In this simulation, we set two groups with either equal or unequal means $p_1,p_2$, then generate proportions using a Dirichlet distribution with parameters $p*10$.

```{r}
get_rmse = function(p_hat,b){
  K = dim(p_hat)[1]
  nb = dim(p_hat)[2]
  nreps = dim(p_hat)[3]
  rmses = c()
  for(i in 1:nb){
    err = c()
    for(j in 1:nreps){
      err[j] = sum((p_hat[,i,j]-b[,i])^2)
    }
    rmses[i] = sqrt(mean(err))
  }
  names(rmses) = paste('bulk',1:nb)
  round(rmses,3)

}

get_coverage_p = function(p_hat,p_hat_se,b){

  K = dim(p_hat)[1]
  nb = dim(p_hat)[2]
  z = array(dim = dim(p_hat))
  for(i in 1:dim(z)[3]){
    z[,,i] = (p_hat[,,i]-b)/p_hat_se[,,i]
  }
  crg = apply(z,c(1,2),function(z){round(mean(abs(z)<1.96,na.rm=T),3)})
  rownames(crg) = paste('cell',1:K)
  colnames(crg) = paste('bulk',1:nb)
  crg
}

```

$(true.cor, est.cor)*(nb=50,nb=100)*("null","all_diff")*(dirichlet5,dirichlet10)$

For each case, we look at:

1. two group mean coverage, and standard errors, of: two sample t test on our method, and music, and our method(non-weighted, weighted, and hc3, cv)


```{r}
K = 4
nreps = 100
alpha.cors = c(0,0.5)
cases = c("null","all_diff")
nbs = c(50,100)
dirichlet.scale = c(5,10)

set.seed(12345)
for(case in cases){

  if(case=='null'){
    p1 = c(0.5,0.3,0.1,0.1)
    p2 = c(0.5,0.3,0.1,0.1)
  }else if(case=='all_diff'){
    p1 = c(0.4,0.3,0.2,0.1)
    p2 = c(0.1,0.1,0.3,0.5)
  }
  dif = p1-p2

  for(nb in nbs){
    for(aa in dirichlet.scale){


      #b1 = t(rdirichlet(nb/2,p1*aa))
      #b2 = t(rdirichlet(nb/2,p2*aa))
      #b = cbind(b1,b2)

      for(alpha.cor in alpha.cors){

        if(alpha.cor==0){
          est_cor = FALSE
          cor.status = 'trueR'
        }else{
          est_cor=TRUE
          cor.status = paste('cor0',alpha.cor*10,sep = '')
        }

        print(paste('Running:',case,'nb=',nb,'cor:',cor.status,'dirichlet scale=',aa))

        #simu_out = simu_study(ref,b,R=A,sigma2,printevery = 1,alpha.cor = alpha.cor,est_cor=est_cor)
        simu_out = readRDS(file = paste('/Volumes/Samsung USB/output/manuscript/simulation/simulation_',nb,'bulk_500genecor_',cor.status,'_',case,'_dirichlet',aa,'.rds',sep=''))
        
        print('two sample t test, weighted meaurement error model')
cover.naive = matrix(nrow = nreps,ncol=K)
sd.naive = matrix(nrow = nreps,ncol=K)
for(i in 1:nreps){
  for(k in 1:K){
    temp = t.test(simu_out$p_hat_weight[k,1:(nb/2),i],simu_out$p_hat_weight[k,(nb/2+1):nb,i])
    sd.naive[i,k] = temp$stderr
    cover.naive[i,k] = (dif[k]>temp$conf.int[1])&(dif[k]<temp$conf.int[2])
  }
}
print(paste("coverage",colMeans(cover.naive)))
print(paste('standard error',round(colMeans(sd.naive),3)))

print('two sample t test, music')
cover.naive.music = matrix(nrow = nreps,ncol=K)
sd.naive.music = matrix(nrow = nreps,ncol=K)
for(i in 1:nreps){
  for(k in 1:K){
    temp = t.test(simu_out$p_hat_music[k,1:(nb/2),i],simu_out$p_hat_music[k,(nb/2+1):nb,i])
    sd.naive.music[i,k] = temp$stderr
    cover.naive.music[i,k] = (dif[k]>temp$conf.int[1])&(dif[k]<temp$conf.int[2])
  }
}
print(paste("coverage",colMeans(cover.naive.music)))
print(paste('standard error',round(colMeans(sd.naive.music),3)))

print('asymptotic,hc3')
temp = abs(simu_out$diff_hat - rep(1,nreps)%*%t(dif))/simu_out$diff_hat_se_cor
cover.asy.hc3 = temp<1.96
print(paste("coverage",round(colMeans(cover.asy.hc3,na.rm=TRUE),2)))
print(paste('standard error',round(colMeans(simu_out$diff_hat_se_cor),3)))

print('asymptotic, weighted, hc3')
temp = abs(simu_out$diff_hat_weight - rep(1,nreps)%*%t(dif))/simu_out$diff_hat_weight_se_cor
cover.asy.hc3 = temp<1.96
round(colMeans(cover.asy.hc3,na.rm=TRUE),2)
round(colMeans(simu_out$diff_hat_weight_se_cor),3)

print('asymptotic, weighted, cv')
temp = abs(simu_out$diff_hat_weight - rep(1,nreps)%*%t(dif))/simu_out$diff_hat_weight_se_cor_cv
cover.asy.cv = temp<1.96
print(paste("coverage:",round(colMeans(cover.asy.cv,na.rm=TRUE),2)))
print(paste("standard error:",round(colMeans(simu_out$diff_hat_weight_se_cor_cv),3)))
        
print("rmse:")
print(paste("our:",mean(get_rmse(simu_out$p_hat_weight,simu_out$input$b))))
print(paste("music:",mean(get_rmse(simu_out$p_hat_music,simu_out$input$b))))

print("coverage of p")
mean(get_coverage_p(simu_out$p_hat_weight,simu_out$p_hat_weight_se_cor,simu_out$input$b))
mean(get_coverage_p(simu_out$p_hat_weight,simu_out$p_hat_weight_se_cor_cv,simu_out$input$b))

      }
    }
  }
}

```

